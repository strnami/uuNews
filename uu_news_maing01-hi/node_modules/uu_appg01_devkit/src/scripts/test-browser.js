const path = require("path");
const shell = require("shelljs");

module.exports = class Test {
  constructor(config) {
    this.config = config;
  }
  async process() {
    shell.exec(`npm run --loglevel=error build -- --transpile-dependencies`);

    let thisConfig = this.config.getAll();
    const { Server, config } = require("karma");
    const configPath = thisConfig.karmaConfig
      ? path.resolve(thisConfig.karmaConfig)
      : path.join(__dirname, "..", "config", "karma.conf.js");
    const karmaConfig = config.parseConfig(configPath);
    if (thisConfig.debug) {
      karmaConfig.debug = true;
      karmaConfig.singleRun = false;
    }
    const server = new Server(karmaConfig, function(exitCode) {
      console.log("Karma has exited with " + exitCode);
      process.exit(exitCode);
    });
    server.start();
  }
};
