"use strict";

const { BaseError, Config } = require("uu_appg01_core-utils");

const DEFAULT_PROVIDER_PARAM = "uu_app_default_authz_provider";

const realizations = {};

/**
 * Service providing authorization checks.
 */
class AuthorizationService {
  /**
   * @returns {string} Name of configuration parameter for accessing default realization of authorization service.
   */
  static get DEFAULT_PROVIDER_PARAM() {
    return DEFAULT_PROVIDER_PARAM;
  }

  /**
   * Checks whether identity represented by the session is authorized to access resources at given uri. In case identity
   * is not authorized, error is not directly raised, but unauthorized authorization context is returned as result.
   * Logic which is performing authorization is then responsible to raise AccessDenied error in case there is no
   * alternative flow to handle unauthorized access.
   * @param {Session} session Instance of session representing authenticated user
   * @param {URI} uri Address of the use case
   * @returns {Promise<AuthorizationResult>} Authorization result
   */
  static async authorize(session, uri) {
    let realization = AuthorizationService.get();
    return await realization.authorize(session, uri);
  }

  /**
   * Returns particular realization of authorization service.
   * @param realizationName Name of required authorization service realization
   * @returns {*} Object responding to "authorize" method
   * @throws {BaseError} In case realization with given name does not exist
   */
  static get(realizationName = null) {
    let name = realizationName || Config.get(DEFAULT_PROVIDER_PARAM);
    let realization = realizations[name];
    if (realization) {
      return realization;
    } else {
      throw new BaseError(`There is no authorization provider with name "${name}".`);
    }
  }

  /**
   * Registers custom realization of authorization service.
   * @param realizationName Custom authorization service realization name
   * @param realization Object responding to "authorize" method
   * @private
   */
  static _register(realizationName, realization) {
    realizations[realizationName] = realization;
  }
}

module.exports = AuthorizationService;
