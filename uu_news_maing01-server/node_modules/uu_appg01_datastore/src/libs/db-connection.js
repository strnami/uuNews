const MongoClient = require("mongodb").MongoClient;

const MONGO_CLIENT_OPTS = {
  reconnectTries: Number.MAX_SAFE_INTEGER,
  useNewUrlParser: true,
  useUnifiedTopology: true
};

class DbConnection {
  constructor() {
    this._connectionsMap = {};
  }

  async _connect(uri) {
    return await MongoClient.connect(uri, MONGO_CLIENT_OPTS);
  }

  async getDbClient(uri) {
    let dbClient;
    if (this._connectionsMap[uri]) {
      dbClient = await this._connectionsMap[uri];
    } else {
      this._connectionsMap[uri] = await this._connect(uri);
      dbClient = this._connectionsMap[uri];
    }
    return dbClient;
  }

  async get(uri) {
    const dbClient = await this.getDbClient(uri);
    return dbClient.db();
  }

  init(uri) {
    if (!this._connectionsMap[uri]) {
      this._connectionsMap[uri] = this._connect(uri);
    }
  }

}

module.exports = new DbConnection();
