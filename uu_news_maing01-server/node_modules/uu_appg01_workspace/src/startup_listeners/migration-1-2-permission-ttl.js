const { DaoFactory } = require("uu_appg01_objectstore");
const { LoggerFactory } = require("uu_appg01_core-logging");

class Migration_1_2_PermissionTtl {
  constructor() {
    this.logger = LoggerFactory.get("UuApp.AppWorkspace.MigrationPermissionTtl");
    this.sysPermissionDao = DaoFactory.getDao("sysPermission");
  }

  async onStartup() {
    if (DaoFactory.isDataStoreOn()) {
      this.logger.debug("Migration started.");
      try {
        await this._migrate();
      } catch (e) {
        this.logger.error("Migration finished with error: ", e);
      }
    }
  }

  async _migrate() {
    let indexes = await this.sysPermissionDao.getIndexes();
    if (
      !indexes.itemList.find(element => {
        return element.name === "expireAt_1";
      })
    ) {
      await this.sysPermissionDao.createIndex({ expireAt: 1 }, { expireAfterSeconds: 0 });
    }
    this.logger.debug("Migration finished without errors.");
  }
}

module.exports = Migration_1_2_PermissionTtl;
