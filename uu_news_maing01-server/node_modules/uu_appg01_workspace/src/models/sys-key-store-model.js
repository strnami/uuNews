"use strict";

const { DaoFactory, ObjectStoreError } = require("uu_appg01_objectstore");
const Errors = require("../errors/sys-key-store-errors");

class SysKeyStoreModel {
  constructor() {
    this.dao = DaoFactory.getDao("sysKeyStore");
  }

  async putKey(awid, keySet, keyCode, key) {
    let keyStoreEntry = await this.getKey(awid, keySet, keyCode);
    if (keyStoreEntry) {
      keyStoreEntry.key = key;
      try {
        keyStoreEntry = await this.dao.update(keyStoreEntry);
      } catch (e) {
        if (e instanceof ObjectStoreError) {
          throw new Errors.PutKey.SysKeyStoreDaoUpdateFailed();
        }
        throw e;
      }
    } else {
      keyStoreEntry = { awid, keySet, keyCode, key };
      try {
        keyStoreEntry = await this.dao.create(keyStoreEntry);
      } catch (e) {
        if (e instanceof ObjectStoreError) {
          throw new Errors.PutKey.SysKeyStoreDaoCreateFailed();
        }
        throw e;
      }
    }
    return keyStoreEntry;
  }

  async getKey(awid, keySet, keyCode) {
    return await this.dao.getByAwidAndKeySetAndKeyCode(awid, keySet, keyCode);
  }

  async listKeys(awid, keySet) {
    return await this.dao.listByAwidAndKeySet(awid, keySet);
  }
}

module.exports = new SysKeyStoreModel();
